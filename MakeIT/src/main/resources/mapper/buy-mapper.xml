<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="buy">
	<select id="buyCount" resultType="_int" parameterType="map">
		select count(distinct buyno) from buy where 1=1
		<choose>
			<when test='sCategoryFlag!=null and sCategoryFlag!=""'> and detailinterestno = #{sCategoryFlag}</when>
		</choose>
		and buy.buycheckyn='Y' and buy.buydeleteyn='N'
	</select>
	
	<select id="buyMainGrade" resultType="map" parameterType="map">
		select buy.buyno,buy.categorycode, buy.memberid,mem.introduction,gr.gradename,gr.gradeno, buy.detailinterestno, buy.interestno, buy.buytitle, buy.buyprice, buy.buydate, buy.buydeleteyn, buy.buycheckyn from buy join member mem on(buy.memberid=mem.memberid) join grade gr on(mem.gradeno=gr.gradeno) where 1 = 1
		<choose>
			<when test='sCategoryFlag!=null and sCategoryFlag!=""'> 
				and buy.detailinterestno = #{sCategoryFlag}
			</when>
		</choose>
		and buy.buycheckyn='Y' and buy.buydeleteyn='N' order by gr.gradeno desc
	</select>
	
	<select id="buyMainNew" resultType="map" parameterType="map">
		select buy.buyno,buy.categorycode, buy.memberid,mem.introduction,gr.gradename,gr.gradeno, buy.detailinterestno, buy.interestno, buy.buytitle, buy.buyprice, buy.buydate, buy.buydeleteyn, buy.buycheckyn from buy join member mem on(buy.memberid=mem.memberid) join grade gr on(mem.gradeno=gr.gradeno) where 1 = 1 
		<choose>
			<when test='sCategoryFlag!=null and sCategoryFlag!=""'> 
				and buy.detailinterestno = #{sCategoryFlag} 
			</when>
		</choose>
		and buy.buycheckyn='Y' and buy.buydeleteyn='N' order by buydate desc
	</select> 
	
	<select id="imageDiv2" parameterType="com.kh.makeit.buy.model.vo.BuyAttach" resultType="com.kh.makeit.buy.model.vo.BuyAttach">
		select BUYIMGNO,BUYNO,CATEGORYCODE,BUYIMGORI,BUYIMGRE from BUYIMG where BUYIMGNO=(select MIN(BUYIMGNO) from BUYIMG where buyno=#{buyno})
	</select>

	<select id="searchCount" parameterType="map" resultType="_int">
		select count(distinct buyno) from buy where 1=1
		<if test='sCategoryFlag!=null and sCategoryFlag!=""'>
			and detailinterestno = #{sCategoryFlag}
		</if>
	
		<if test='searchtype=="title"'>
			and buytitle like '%'||#{searchValue}||'%'
		</if>
		<if test='searchtype=="writer"'>
			and memberid like '%'||#{searchValue}||'%'
		</if>
		and buy.buycheckyn='Y' and buy.buydeleteyn='N'
	</select>
	
	<select id="buySearch" parameterType="map" resultType="map">
		<if test='newValue=="1"'>
			select buy.buyno,buy.categorycode, buy.memberid,mem.introduction,gr.gradename,gr.gradeno, buy.detailinterestno, buy.interestno, buy.buytitle, buy.buyprice, buy.buydate, buy.buydeleteyn, buy.buycheckyn from buy join member mem on(buy.memberid=mem.memberid) join grade gr on(mem.gradeno=gr.gradeno) where 1 = 1
		</if>
		<if test='gradeValue=="1"'>
			select buy.buyno,buy.categorycode, buy.memberid,mem.introduction,gr.gradename,gr.gradeno, buy.detailinterestno, buy.interestno, buy.buytitle, buy.buyprice, buy.buydate, buy.buydeleteyn, buy.buycheckyn from buy join member mem on(buy.memberid=mem.memberid) join grade gr on(mem.gradeno=gr.gradeno) where 1 = 1
		</if>
		<if test='searchtype=="title"'>
			and buytitle like '%'||#{searchValue}||'%'
		</if>
		<if test='searchtype=="writer"'>
			and buy.memberid like '%'||#{searchValue}||'%'
		</if>
		<if test='sCategoryFlag!=null and sCategoryFlag!=""'>
			and detailinterestno=#{sCategoryFlag}
		</if>
		<if test='newValue=="1"'>
			and buy.buycheckyn='Y' and buy.buydeleteyn='N' order by buydate desc
		</if>
		<if test='gradeValue=="1"'>
			and buy.buycheckyn='Y' and buy.buydeleteyn='N' order by mem.gradeno desc
		</if>
	</select>
	
	<insert id="insertBuy" parameterType="map" >
		INSERT INTO BUY VALUES(SEQ_BUYNO.NEXTVAL, 'B', #{detailInterest}, #{interest}, #{title}, DEFAULT, #{content}, #{price}, #{writer}, DEFAULT, DEFAULT)
		<selectKey keyProperty="buyNo" resultType="string" order="AFTER">
			SELECT SEQ_BUYNO.CURRVAL FROM DUAL 
		</selectKey>		
	</insert>
	
	<insert id="insertAttach" parameterType="com.kh.makeit.buy.model.vo.BuyAttach">
		INSERT INTO BUYIMG VALUES(SEQ_BUYIMGNO.NEXTVAL, #{buyNo}, 'B', #{buyImgOri}, #{buyImgRe})
	</insert>
	
	<select id="buyDetail" parameterType="_int" resultType="map">
		SELECT * FROM BUY JOIN MEMBER ME ON(BUY.MEMBERID = ME.MEMBERID) JOIN GRADE GR ON(GR.GRADENO = ME.GRADENO) WHERE BUYNO = #{buyNo}
	</select>
	<select id="selectBuyImg" parameterType="_int" resultType="map">
		SELECT * FROM BUYIMG WHERE BUYNO = #{buyNo} ORDER BY BUYIMGNO ASC
	</select>
	<select id="selectMainImg" parameterType="_int" resultType="map">
		SELECT * FROM BUYIMG WHERE BUYIMGNO = (SELECT MIN(BUYIMGNO) FROM BUYIMG WHERE BUYNO = #{buyNo})
	</select>
	<select id="selectSubImg" parameterType="_int" resultType="map">
		SELECT * FROM BUYIMG WHERE BUYNO = #{buyNo} and BUYIMGNO NOT IN (SELECT MIN(BUYIMGNO) FROM BUYIMG WHERE BUYNO = #{buyNo})
	</select>
	<select id="selectReview" parameterType="_int" resultType="map">
		SELECT * FROM BUYREVIEW WHERE BUYNO = #{buyNo} ORDER BY BUYREVIEWNO DESC
	</select>
	<insert id="insertReview" parameterType="map">
		INSERT INTO BUYREVIEW VALUES(SEQ_BUYREVIEWNO.NEXTVAL, #{reviewContent}, #{buyNo}, #{starCount}, #{memberId}, 'B')
	</insert>
	<select id="selectReviewCnt" parameterType="_int" resultType="_int">
		SELECT COUNT(*) FROM BUYREVIEW WHERE BUYNO=#{buyNo}
	</select>
	<select id="selectSpec" parameterType="map" resultType="map">
		SELECT * FROM BUYSPEC WHERE BUYNO = #{buyNo} AND MEMBERID = #{memberId} AND CATEGORYCODE = 'B'
	</select>
	<select id="selectAnother" parameterType="string" resultType="map">
		select buy.buyno,buy.categorycode, buy.memberid,mem.introduction,gr.gradename,gr.gradeno, buy.detailinterestno, buy.interestno, buy.buytitle, buy.buyprice, buy.buydate, buy.buydeleteyn, buy.buycheckyn from buy join member mem on(buy.memberid=mem.memberid) join grade gr on(mem.gradeno=gr.gradeno) where buy.memberid = #{memberId} and categorycode = 'B' order by buydate desc
	</select>
	<select id="anotherCount" parameterType="string" resultType="_int">
		SELECT COUNT(DISTINCT BUYNO) FROM BUY WHERE MEMBERID = #{memberId}
	</select>
	<insert id="insertVol" parameterType="map">
		INSERT INTO BUYCANDIDATE VALUES(#{memberId}, #{buyNo}, 'B', #{title}, #{content}, DEFAULT)
	</insert>
	<insert id="insertVolImg" parameterType="map">
		INSERT INTO BUYCANDIDATEFILE VALUES(SEQ_BUYCANDIDATEFILENO.NEXTVAL, #{memberId}, #{buyNo}, 'B', #{oriName}, #{reName})
	</insert>
	<delete id="deleteReview" parameterType="map">
		DELETE FROM BUYREVIEW WHERE BUYNO = #{buyNo} AND BUYREVIEWNO = #{reviewNo} AND CATEGORYCODE = 'B'
	</delete>
	<update id="updateReview" parameterType="map">
		UPDATE BUYREVIEW SET BUYREVIEWCONTENT = #{reviewContent}, BUYREVIEWSTAR = #{starCount} WHERE BUYNO = #{buyNo} AND BUYREVIEWNO = #{reviewNo} AND CATEGORYCODE = 'B'
	</update>
	<select id="selectVolList" parameterType="map" resultType="map">
		SELECT * FROM BUYCANDIDATE WHERE BUYNO = #{buyNo} AND CATEGORYCODE = #{category} ORDER BY BUYCANDIDATEDATE
	</select>
	<select id="selectVolView" parameterType="map" resultType="map">
		SELECT * FROM BUYCANDIDATE WHERE MEMBERID = #{memberId} AND BUYNO = #{buyNo} AND CATEGORYCODE = #{category}
	</select>
	<select id="selectDownImg" parameterType="map" resultType="map">
		SELECT * FROM BUYCANDIDATEFILE WHERE MEMBERID = #{memberId} AND BUYNO = #{buyNo} AND CATEGORYCODE = #{category}
	</select>
	<insert id="insertBuySpec" parameterType="map">
		INSERT INTO BUYSPEC VALUES(SEQ_BUYSPECNO.NEXTVAL, #{memberId}, #{buyNo}, 'B', DEFAULT, 2, DEFAULT)
	</insert>
	<select id="selectVolCount" parameterType="string" resultType="int">
		SELECT COUNT(*) FROM BUYCANDIDATE WHERE BUYNO = #{buyNo} AND CATEGORYCODE = 'B'
	</select>
	<select id="selectMemberImg" parameterType="string" resultType="map">
		SELECT * FROM MEMBER WHERE MEMBERID = #{memberId}
	</select>
	<select id="buyOutBoxYn" parameterType="map" resultType="map">
		select * from buyoutbox where buyno=#{buyNo} and categorycode='B'and memberid=#{memberId}
	</select>
	<insert id="buyOutBoxInsert" parameterType="map">
		insert into buyoutbox values(#{buyNo},'B',#{memberId})
	</insert>
	<delete id="buyOutBoxDelete" parameterType="map">
		delete from buyoutbox where buyno=#{buyNo} and categorycode='B' and memberid=#{memberId}
	</delete>
	<!-- 신고하기 인서트 -->
	<insert id="insertReport" parameterType="map">
		insert into BUYREPORT values(SEQ_BUYREPORTNO.NEXTVAL,#{buyNo},'B',#{reportId},#{reportContent},default,default)
	</insert>
	<!-- 환불신청 -->
	<update id="buyRefund" parameterType="map">
		UPDATE BUYSPEC SET STATUSNO = 6, BUYREASONREFUND = #{refundContent} WHERE BUYSPECNO = #{specNo}
	</update>
	<!-- 구매확정 -->
	<update id="buyCommit" parameterType="string">
		UPDATE BUYSPEC SET STATUSNO = 4 WHERE BUYSPECNO = #{specNo}
	</update>
	<!-- 작업완료 -->
	<update id="finishWork" parameterType="map">
		UPDATE BUYSPEC SET STATUSNO = 3 WHERE BUYNO = #{buyNo} AND MEMBERID = #{sellerId}
	</update>
	
	<select id="selectSpec2" parameterType="_int" resultType="map">
		SELECT * FROM BUYSPEC WHERE BUYNO = #{buyNo}
	</select>
	<select id="buyModifyImg" parameterType="_int" resultType="map">
		SELECT * FROM BUYIMG WHERE BUYNO = #{buyNo} ORDER BY BUYIMGNO ASC
	</select>
	
	<update id="modifyBuy" parameterType="map">
		UPDATE BUY SET BUYTITLE = #{title}, BUYCONTENT = #{content}, BUYPRICE = #{price}, DETAILINTERESTNO = #{detailInterest}, INTERESTNO = #{interest} WHERE BUYNO = #{buyNo}
	</update>
	<delete id="deleteAttach" parameterType="map">
		DELETE FROM BUYIMG WHERE BUYNO = #{buyNo}
	</delete>
	<update id="buyDelete" parameterType="_int">
		UPDATE BUY SET BUYDELETEYN = 'Y' WHERE BUYNO = #{buyNo}
	</update>
	<insert id="insertBuyImg" parameterType="map">
		INSERT INTO BUYIMG VALUES(SEQ_BUYIMGNO.NEXTVAL, #{BUYNO}, 'B', #{BUYIMGORI}, #{BUYIMGRE})
	</insert>
	<select id="selectCtgList" resultType="map">
		SELECT * FROM DETAILINTEREST
	</select>
</mapper>
